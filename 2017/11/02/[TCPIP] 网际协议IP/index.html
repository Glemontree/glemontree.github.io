<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>[TCP/IP] 网际协议IP | day day up!</title>
    <meta name="author" content="Glemontree">
    
    <meta name="description" content="记录我学习的每一步">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="[TCP/IP] 网际协议IP"/>
    <meta property="og:site_name" content="Glemontree&#39;s blog"/>

    
    <meta property="og:image" content="undefined"/>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="Glemontree&#39;s blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/prettify-tomorrow-night-eighties.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>


<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="indigo">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">Glemontree&#39;s blog</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-reading " href="/reading" >
                            <i class="fa fa-book "></i>
                            
                            读书
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about" >
                            <i class="fa fa-user "></i>
                            
                            关于
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            搜索
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav indigo darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="http://a2.qpic.cn/psb?/7f08dc85-11f9-4e2c-98bf-46f57deaea51/y3454JNrI*wKHx2Q4UGOkYW5ceOFrz5b1VKCL6GAt7A!/m/dDEBAAAAAAAAnull&amp;bo=hAOEAwAAAAARBzA!&amp;rf=photolist&amp;t=5" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">Glemontree</p>
                        <p class="desc">Java后端/Android/C++/Linux/技术宅</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    首页
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    归档
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    分类
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-reading " href="/reading" >
                    <i class="fa fa-book "></i>
                    
                    读书
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about" >
                    <i class="fa fa-user "></i>
                    
                    关于
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    搜索
                </a>
            </li>
        
    </ul>

    <ul class="side-nav indigo darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Android/">
                    Android <span class="right">15 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/C/">
                    C <span class="right">24 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Boost/">
                    Boost <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/CMake/">
                    CMake <span class="right">2 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/DB/">
                    DB <span class="right">7 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Effective-Java/">
                    Effective-Java <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Hexo/">
                    Hexo <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/HTTPS/">
                    HTTPS <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/JQuery/">
                    JQuery <span class="right">8 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/IntelliJ-IDEA/">
                    IntelliJ-IDEA <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Java/">
                    Java <span class="right">16 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Linux/">
                    Linux <span class="right">22 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/MyBatis/">
                    MyBatis <span class="right">8 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Qt/">
                    Qt <span class="right">4 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Redis/">
                    Redis <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Servlet/">
                    Servlet <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/SpringMVC/">
                    SpringMVC <span class="right">4 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Spring/">
                    Spring <span class="right">5 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Struts2/">
                    Struts2 <span class="right">18 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/TCP-IP/">
                    TCP-IP <span class="right">9 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/TCPIP/">
                    TCPIP <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Windows核心编程/">
                    Windows核心编程 <span class="right">2 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/html/">
                    html <span class="right">7 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/算法/">
                    算法 <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/多线程/">
                    多线程 <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/编程规范/">
                    编程规范 <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/网络编程/">
                    网络编程 <span class="right">2 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/设计模式/">
                    设计模式 <span class="right">5 篇</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">搜索</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper indigo">
        <span class="breadcrumb">当前位置（分类目录）</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/TCP-IP/">TCP/IP</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>[TCP/IP] 网际协议IP</h1>
    


            </div>
            <time class="pink-link-context" datetime="2017-11-02T03:23:02.000Z"><a href="/2017/11/02/[TCPIP] 网际协议IP/">2017-11-02</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <i class="fa fa-eye"></i>
    <span id="busuanzi_value_page_pv"></span>
</span>

            
    <div class="tags-row">
        
            <a href="/tags/IP/" class="chip pink lighten-1">IP</a>
        
    </div>


            <div class="toc pink-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#网络相关知识"><span class="section table-of-contents-text">网络相关知识</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#数据报"><span class="section table-of-contents-text">数据报</span></a></li></ol>
</div>


            <div class="entry pink-link-context">
                <blockquote>
<p>  IP是整个TCP/IP协议的核心，TCP、UDP、ICMP、IGMP等协议都基于IP来传送协议数据，常见的广域网路由器就工作在IP层，它们负责将IP数据报从源主机送至目的主机。</p>
</blockquote>
<h2 id="网络相关知识"><a href="#网络相关知识" class="headerlink" title="网络相关知识"></a>网络相关知识</h2><ul>
<li><p>IP是一种不可靠的无连接数据报协议，它提供尽量最大努力交付服务，但是并不保证每个分组都能被正确送达，此外，IP不会对运载的数据进行差错校验和跟踪。</p>
</li>
<li><p>IP地址被分为A，B，C，D，E五类，在分类地址中，IP地址由网络号和主机号组成，网络号标识某个网络，主机号标识该网络内的某台主机，这两个部分的长度是可变的，主要取决于地址的类型：对于A类地址，第一个字节定义网络号，后三个字节定义主机号；对于B类地址，前两个字节定义网络号，后两个字节定义主机号；对于C类网络地址，前三个字节定义网络号，最后一个字节定义主机号；对于D类和E类地址，不进行主机号和网络号的划分，D类地址是多播（组播）地址，而E类地址保留未用。</p>
</li>
<li><p>网络地址：用来标识不同的网络，不指向具体的哪一个主机或设备，而是标识属于同一个网络的主机或网络设备的集合。当一个数据包到达一个网络时，该网络的路由器首先判断数据包的目的网络是否与本地网络号相匹配，如果两个地址不匹配，那么路由器将会根据合适的算法对数据包进行转发，只有两个地址相互匹配，路由器才会查找响应的主机号进行主机的匹配，最后将数据包发送到指定的主机。</p>
</li>
<li><p>子网编址：将网络进一步划分为子网的设计，允许多个物理网络共享一个网络前缀，但每个子网都有自己的子网地址。在子网编址中，将主机号再划分为一个子网号和主机号。</p>
</li>
<li><p>NAT（网络地址转换）</p>
<p>通常，企业内部使用的局域网路由器都是具有NAT功能的，具有NAT功能的路由器至少有一个内部端口和一个外部端口，内部端口是路由器为了与局域网内的用户通信而使用的，它使用一个内部专用的IP地址，例如常见的路由器内部IP地址为192.168.1.1，外部端口是路由器用来与外部网络通信用的，它通常具有一个有效的IP地址，例如一个有效的C类地址222.197.179.21。</p>
<p>当内部网络用户连接互联网时，NAT将用户的内部IP地址转换成一个外部公共IP地址，反之，数据从外部返回时，NAT将目的地址替换成用户的内部IP地址。</p>
<p>NAT的实现方式有很多种，使用最广泛的是端口多路复用，它基于TCP或UDP协议端口号以及IP地址来实现NAT功能。假如我们的局域网用户（专用地址是192.168.1.78）需要使用TCP协议与Internet中的一个Http服务器进行通信（IP地址为130.21.45.20，服务端口号是80），则它将发送一个包含源IP地址、源端口号、目的IP地址、目的端口号的IP分组到路由器处，这里假设这四个值为：（192.168.1.78, 1234, 130.21.45.20, 80），具有NAT功能的路由器会在内部维护一个NAT转换表，当路由器收到该分组时，会在表中为连接（192.168.1.78, 1234, 130.21.45.20, 80）分配一个路由器内部的NAT端口（假设为5678），另一方面，路由器在转发该分组时，会先更改分组中的源IP地址和端口号（分别改为路由器外部IP地址和NAT端口），然后才将数据包发送出去，所以被路由器转发出去的数据包中的信息为（222.178.197.21,5678,130.21.45.20,80），当服务器响应这个数据包时，它返回的数据报头部信息应为（130.21.45.20,80,222.178.197.21,5678），路由器接收到这个分组后，会在NAT转换表中查找NAT端口号为5678的连接，并把数据分组中的IP地址信号和端口信号更改为NAT转换表中记录的信息（130.21.45.20,80,192.168.1.78, 1234），最后把这个数据包返回给用户主机。</p>
<p>经过NAT两次简单的转换，局域网用户就实现了与外部网络的数据包交互，但是路由器应该为每个连接分配一个唯一的NAT端口号，并及时回收那些不用的端口号。</p>
</li>
</ul>
<h2 id="数据报"><a href="#数据报" class="headerlink" title="数据报"></a>数据报</h2><ul>
<li><p>IP层的数据包，更正式的叫IP数据报或IP分组，在以太网中，IP数据报和ARP报文都是组装在以太网数据帧中发送的。</p>
</li>
<li><p>IP数据报的组织形式：通常有两部分组成，即IP首部和数据，首部常见长度为20个字节，IP数据报对数据的格式没有规定，所以IP数据报可以用来运输任意类型的数据。</p>
</li>
<li><p>IP数据报的组成：</p>
</li>
<li><p>版本号（4bit）：包含了创建数据报所使用的IP协议版本信息，对于IPv4，该值为4，对于IPv6，该值为6</p>
</li>
<li><p>首部长度（4bit）：这个长度以字为单位（4字节），对于不含任何选项字段的IP首部，该长度值为5（5*4=20字节），该字段最大值为15，所以最大IP首部长度为60字节</p>
</li>
<li><p>服务类型字段（8bit）：Type of Service, TOS，该字段主要用于描述当前IP数据报急需的服务类型，如最小延时、最大吞吐量、最高可靠性、最小费用等，路由器在转发数据报时可以根据这个字段的值来为数据报选择最合理的路由路径</p>
</li>
<li><p>总长度字段（16bit）：描述了整个IP数据报（IP首部和数据区）的总字节数，理论来说，IP数据报总长度最大可达65535字节，但在实际应用中，底层链路不允许这么大的数据包出现在链路中，在以太网中，以太网数据帧中的数据长度最长为1500字节（MTU），当一个很大的IP数据报需要发送时，IP层首先要检查底层接口设备的MTU，然后将大的数据报划分为几个分片包，最后分别递交给底层发送；另一方面，当以太网数据帧中的数据量较少时，例如小于46字节，底层会在以太网数据中加入一定的填充字节以满足长度要求</p>
</li>
<li><p>标识字段（16bit）：用于标识IP层发送出去的每一份IP数据报，没发送一份报文，则该值加1，数据包被分片时，该字段会被复制到每一个分片中，在接收端，会使用这个字段值来组装所有分片为一个完整的数据报</p>
</li>
<li><p>标志字段（3bit）：第一位保留，第二位为不分片位，当该位被置位时，IP数据报在发送或转发过程中，不能进行分片，在这种情况下，如果这个数据报由于太大而不能被放在任何物理网络中进行发送，那么这个数据报会被丢弃，当该位为0时，IP层将在需要的时候对数据包进行分片处理；第三位表示更多分片位，当该位被置1时，说明该分片不是某个数据报的最后一个分片，当该位为0时，表示该分片时某个数据报的最后一个分片，或者是某个数据报的唯一分片</p>
</li>
<li><p>片偏移字段（13bit）：当前分片所携带的数据在整个数据报中的相对位置（以8字节为单位），目的站必须收到从0偏移量到最高偏移量的所有分片，才能将分片重装为一个完整的数据报，每个分片在网络中单独传输，它们到达终点的顺序可能会各不相同，但在目的端，将按照分片的偏移量来顺序组织各个分片</p>
</li>
<li><p>生存时间（TTL）：描述IP数据报最多能被转发的次数，每经过一次转发，该值会减一，当该值为0时，路由器会丢弃该分组，同时一个ICMP差错报文会返回到源主机</p>
</li>
<li><p>协议字段（8bit）：描述数据报中的数据是来自于哪个上层协议，该位为1表示ICMP协议，为2表示IGMP协议，为6表示TCP协议，为17表示UDP协议</p>
</li>
<li><p>首部检验和（16bit）：针对IP首部进行校验，它并不关心内部数据在传输过程中出错与否，对于数据的校验是上层协议负责的，如ICMP、IGMP、TCP、UDP协议都会计算它们头部以及整个数据区的校验和</p>
</li>
<li><p>IP层输出</p>
</li>
<li><p>发送数据报</p>
<p>当传输层协议（TCP或UDP）要发送数据时，它们会将数据按照自己的格式组装在一个pbuf    中，并将payload指针指向协议首部，然后调用IP层的数据报发送函数ip_output    发送数据，ip_output的调用者需要为它提供数据报首部中的目的IP地址、源IP地址、协议类型、TTL等重要信息，ip_output的函数源代码如下，它主要的工作是根据目的IP地址为该数据报选择一个合适的网络接口，然后调用函数ip_output_if将数据报发送出去。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">	函数功能：被传输层协议调用以发送数据报，该函数查找网络接口并调用函数ip_output_if完成最终的发送工作</div><div class="line">	@p: 传输层协议需要发送的数据包pbuf，payload指针已指向协议首部</div><div class="line">	@src:源IP地址，若为NULL，则使用网络接口结构中保存的IP地址</div><div class="line">	@dest：目的IP地址，若为IP_HDRINCL，则表示p中已经有了填写好的IP数据报首部，且payload指针也已经指向了IP首部</div><div class="line">	@ttl：IP首部中的TTL字段</div><div class="line">	@tos：IP首部中的服务类型</div><div class="line">	@proto：IP首部中的协议类型值</div><div class="line">*/</div><div class="line"><span class="keyword">err_t</span> ip_output(<span class="keyword">struct</span> pbuf* p, <span class="keyword">struct</span> ip_addr* src, <span class="keyword">struct</span> ip_addr* dest, <span class="keyword">u8_t</span> ttl, <span class="keyword">u8_t</span> tos, <span class="keyword">u8_t</span> proto) &#123;</div><div class="line">  <span class="keyword">struct</span> netif* netif;</div><div class="line">  <span class="comment">//根据目的IP地址为数据报寻找一个合适的网络接口</span></div><div class="line">  <span class="keyword">if</span> ((netif = ip_route(dest)) == <span class="literal">NULL</span>) &#123;</div><div class="line">    <span class="keyword">return</span> ERR_RTE;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> ip_output_if(p, src, dest, ttl, tos, proto, netif);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">err_t</span> ip_output_if(<span class="keyword">struct</span> pbuf* p, <span class="keyword">struct</span> ip_addr* src, <span class="keyword">struct</span> ip_addr* dest, <span class="keyword">u8_t</span> ttl, <span class="keyword">u8_t</span> tos, <span class="keyword">u8_t</span> proto, <span class="keyword">struct</span> netif* netif) &#123;</div><div class="line">  <span class="keyword">struct</span> ip_hdr* iphdr;</div><div class="line">  <span class="keyword">static</span> <span class="keyword">u16_t</span> ip_id = <span class="number">0</span>; <span class="comment">// 静态变量，记录IP数据报的编号（标识字段）</span></div><div class="line">  <span class="keyword">if</span> (dest != IP_HDRINCL) &#123;</div><div class="line">  	<span class="keyword">u16_t</span> ip_hlen = IP_HLEN; <span class="comment">// IP_HLEN为默认的IP首部长度，20</span></div><div class="line">    <span class="keyword">if</span> (pbuf_header(p, IP_HLEN)) &#123; <span class="comment">// 移动payload指针，指向pbuf中的IP首部</span></div><div class="line">  	  <span class="keyword">return</span> ERR_BUF;</div><div class="line">	&#125;</div><div class="line">    iphdr = p-&gt;payload; <span class="comment">// iphdr指向数据报首部</span></div><div class="line">    IPH_TTL_SET(iphdr, ttl);</div><div class="line">    IPH_PROTO_SET(iphdr, proto);</div><div class="line">    ip_addr_set(&amp;(iphdr-&gt;dest), dest);</div><div class="line">    IPH_VHLTOS_SET(iphdr, <span class="number">4</span>, ip_hlen / <span class="number">4</span>, tos); <span class="comment">// 填写版本号+首部长度+服务类型</span></div><div class="line">    IPH_LEN_SET(iphdr, htons(p-&gt;tot_len)); <span class="comment">// 填写数据报总长度</span></div><div class="line">    IPH_OFFSET_SET(iphdr, <span class="number">0</span>); <span class="comment">// 填写标志位和片偏移字段，都为0</span></div><div class="line">    IPH_ID_SET(iphdr, htons(ip_id)); <span class="comment">// 填写标识字段</span></div><div class="line">    ++ip_id; <span class="comment">// 数据报编号值加1</span></div><div class="line">    <span class="keyword">if</span> (ip_addr_isany(src)) &#123;<span class="comment">// 若src为空，则将源IP地址填写为网络接口的IP地址</span></div><div class="line">      ip_addr_set(&amp;(iphdr-&gt;src), &amp;(netif-&gt;ip_addr));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">  	  ip_addr_set(&amp;(iphdr-&gt;src), src);</div><div class="line">	&#125;</div><div class="line">    IPH_CHKSUM_SET(iphdr, <span class="number">0</span>); <span class="comment">// 清0校验和字段</span></div><div class="line">    IPH_CHKSUM_SET(iphdr, inet_chksum(iphdr, ip_hlen)); <span class="comment">// 计算并填写首部校验和</span></div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">  	iphdr = p-&gt;payload;</div><div class="line">    dest = &amp;(iphdr-&gt;dest);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 下面开始发送IP数据报，分为三种情况进行处理</span></div><div class="line">  <span class="keyword">if</span> (ip_addr_cmp(dest, &amp;netif-&gt;ip_addr)) &#123; <span class="comment">// 如果目的IP地址是本网卡的地址</span></div><div class="line">  	<span class="keyword">return</span> netif_loop_output(netif, p ,dest);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (netif-&gt;mtu &amp;&amp; (p-&gt;tot_len &gt; netif-&gt;mtu)) &#123;</div><div class="line">  	<span class="keyword">return</span> ip_frag(p, netif, dest);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> netif-&gt;output(netif, p, dest);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于最后一种情况，会调用网卡结构注册的output函数来完成数据报的发送工作，这里这个函数应为etharp_output，它会解析MAC地址，组装以太网帧并发送。</p>
<p>​</p>
<p>​</p>
</li>
</ul>

                
<p class="pink-link-context">
    <a href="/2017/11/02/[TCPIP] 网络接口管理/" rel="next" title="[TCP/IP] 网络接口管理">
    上一篇：[TCP/IP] 网络接口管理
  </a>
</p>



<p class="pink-link-context">
    <a href="/2017/11/02/[TCPIP] 数据包管理/" rel="next" title="[TCP/IP] 数据包管理">
    下一篇：[TCP/IP] 数据包管理
  </a>
</p>


            </div>
			
        </div>
    </div>
</article>






</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large pink">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect green" title="回到顶部"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse yellow darken-1"  data-activates="main-menu" title="菜单"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer indigo darken-1">
    
    <div class="footer-container container">
        <div class="row">
            
            <div class="social-group col m4 s12">
                <h5 class="white-text">社交</h5>
                
                    <a class="social-link" href="https://weibo.com/2520520192" target="_blank">
                        <i class="fa fa-2x fa-weibo"></i>
                    </a>
                
                    <a class="social-link" href="https://github.com/Glemontree" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                    <a class="social-link" href="/atom.xml" target="_blank">
                        <i class="fa fa-2x fa-rss"></i>
                    </a>
                
                
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>
    <div class="site-visitors-container white-text">
        <span>
            <i class="fa fa-user"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
        </span>
        <span>&nbsp;|&nbsp;</span>
        <span>
            <i class="fa fa-eye"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
        </span>
    </div>


            </div>
            

            
            <div class="col m8 s12">
                <h5 class="white-text">友情链接</h5>
                
                    <a class="social-link" href="https://glemontree.github.io/" target="_blank">我的博客</a>
                
                    <a class="social-link" href="https://github.com/Glemontree" target="_blank">Github地址</a>
                
            </div>
            
        </div>
    </div>
    

    <div class="footer-copyright pink-link-context">
        <div class="container">
            © 2016 example.com, All rights reserved.
            <p class="right" style="margin-top: 0;">本博客由 <a href="https://hexo.io">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/raytaylorlin/hexo-theme-raytaylorism">raytaylorism</a></p>
        </div>
    </div>
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('pink lighten-2');

            
            // 添加new标签
            $('.menu-reading, .menu-about').append('<span class="new badge pink"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "search.xml";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>




<script type="text/javascript" src="http://tajs.qq.com/stats?sId=65601540" charset="UTF-8"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script type="text/javascript" async
  src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



</body>
</html>
